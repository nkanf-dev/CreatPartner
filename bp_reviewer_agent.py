from enum import StrEnum
from pydantic import BaseModel, Field
from pydantic_ai import Agent
from config import get_model_name, create_llm_provider


class CompetitionGroup(StrEnum):
    """
    比赛赛道分组
    """

    # 高教主赛道
    MAIN_CREATIVITY = "高教主赛道-创意组"
    MAIN_ENTREPRENEURSHIP = "高教主赛道-创业组"

    # 红旅赛道
    RED_TOUR_PUBLIC_WELFARE = "红旅赛道-公益组"
    RED_TOUR_CREATIVITY = "红旅赛道-创意组"
    RED_TOUR_ENTREPRENEURSHIP = "红旅赛道-创业组"

    # 产业赛道
    INDUSTRY_ENTERPRISE_PROPOSITION = "产业赛道-企业命题组"
    INDUSTRY_ACHIEVEMENT_TRANSFORMATION = "产业赛道-成果转化组"


class BPReviewContext(BaseModel):
    group: CompetitionGroup = Field(..., description="赛道-组别")
    bp_content: str = Field(..., description="商业计划书内容")


group_rules_map: dict[CompetitionGroup, str] = {
    CompetitionGroup.MAIN_CREATIVITY: """
### **个人成长 (30分)**
1.  **立德树人**：项目弘扬正确价值观，厚植家国情怀，恪守伦理规范，有助于培育创新精神。
2.  **调研深入**：项目扎根中国大地了解国情民情，鼓励学生深入社会、行业、实验场所选题立项、调查研究、试验论证。
3.  **逻辑正确**：项目符合将专业知识与商业知识有效结合并转化为商业价值或社会价值的创新创业基本过程和基本逻辑，展现创新教育对大学生基本素养和认知的塑造力。
4.  **知识掌握与应用能力**：体现对创新创业所需知识（专业知识、商业知识、行业知识等）与技能（计划、组织、领导、控制、创新等）的娴熟掌握；体现用课堂和实验室学到的知识解决实际问题的综合能力和高级思维；体现项目成长对团队成员创新精神、创新意识、创新能力的锻炼和提升作用，展现创新教育提升大学生综合能力的效力。
5.  **人才培养成效**：项目能充分体现院校扎实推进新工科、新医科、新农科、新文科建设方面取得的成果；体现院校在项目的培育、孵化等方面的支持情况；体现产教融合、科教融汇、多学科交叉、专创融合、产学研协同创新等模式在项目的产生与执行中的重要作用。

### **项目创新 (30分)**
1.  **问题导向**：项目遵循从创意到研发、试制、生产、进入市场的创新一般过程，进而实现从创意向实践、从基础研发向应用研发的跨越。
2.  **目标导向**：团队能够基于学科专业知识并运用各类创新的理念和范式，解决社会和市场的实际需求。
3.  **创新成效**：项目能够从产品创新、工艺流程创新、服务创新、商业模式创新等方面着手开展创新创业实践，并产生一定数量和质量的创新成果以体现团队的创新力。

### **产业价值 (25分)**
1.  **产业认知**：对所在产业（行业）的产业规模、增长速度、竞争格局、产业趋势、产业政策等情况充分了解，形成完备、深刻的产业认知。
2.  **市场定位**：项目具有明确的目标市场定位，对目标市场的特征、需求等情况有清晰的了解，并据此制定合理的营销、运营、财务等计划，设计出完整、创新、可行的商业模式，展现团队的商业思维。
3.  **落地前景**：项目落地执行情况，对促进区域经济发展、产业转型升级的情况；已有盈利能力或盈利潜力情况。项目是否具备国际化发展的潜力。
4.  **社会影响**：项目直接或间接带动就业的数量和质量，对社会文明、生态文明、民生福祉等方面的积极推动作用。

### **团队协作 (15分)**
1.  **团队精神**：团队具有明确的使命愿景，具有团结协作的创新精神，具有支撑项目成长的知识、技术和经验。
2.  **团队结构**：团队的组织构架、人员配置、分工协作、能力结构、专业结构、合作机制、激励制度等的合理性情况。鼓励留学生参与，促进中外合作交流。
3.  **团队效能**：团队与项目关系的真实性、紧密性情况；对项目的各项投入情况；创立创业企业的可能性情况。
4.  **团队资源**：支撑项目发展的合作伙伴等外部资源的使用以及与项目关系的情况。
""".strip(),
    CompetitionGroup.MAIN_ENTREPRENEURSHIP: """
### **个人成长 (25分)**
1.  **立德树人**：项目弘扬正确价值观，厚植家国情怀，恪守伦理规范，有助于培育创新精神。
2.  **调研深入**：项目扎根中国大地了解国情民情，鼓励学生深入社会、行业、实验场所选题立项、调查研究、试验论证。
3.  **逻辑正确**：项目符合将专业知识与商业知识有效结合并转化为商业价值或社会价值的创新创业基本过程和基本逻辑，展现创新教育对大学生基本素养和认知的塑造力。
4.  **知识掌握与应用能力**：体现对创新创业所需知识（专业知识、商业知识、行业知识等）与技能（计划、组织、领导、控制、创新等）的娴熟掌握；体现用课堂和实验室学到的知识解决实际问题的综合能力和高级思维；体现项目成长对团队成员创新精神、创新意识、创新能力的锻炼和提升作用，展现创新教育提升大学生综合能力的效力。
5.  **人才培养成效**：项目能充分体现院校扎实推进新工科、新医科、新农科、新文科建设方面取得的成果；体现院校在项目的培育、孵化等方面的支持情况；体现产教融合、科教融汇、多学科交叉、专创融合、产学研协同创新等模式在项目的产生与执行中的重要作用。

### **项目创新 (30分)**
1.  **问题导向**：项目遵循从创意到研发、试制、生产、进入市场的创新一般过程，进而实现从创意向实践、从基础研发向应用研发的跨越。
2.  **目标导向**：团队能够基于专业知识并运用各类创新的理念和范式，解决社会和市场的实际需求。
3.  **创新成效**：项目能够从产品创新、工艺流程创新、服务创新、商业模式创新等方面着手开展创新实践，产生一定数量和质量的创新成果，获得相应的市场回报。
4.  **发展前景**：项目能够从创新战略、创新流程、创新组织、创新制度与文化等方面进行设计协同，对创新进行有效管理，进而保持公司的竞争力。

### **产业价值 (30分)**
1.  **产业发展**：充分掌握所在产业（行业）的产业规模、增长速度、竞争格局、产业趋势、产业政策等情况；具有明确的目标市场定位，充分掌握目标市场的特征、需求等情况；具有完整、创新、可行的商业模式。
2.  **经营绩效**：重点考察项目存续时间、营业收入（合同订单）现状、企业利润、持续盈利能力、市场份额、客户（用户）情况、税收上缴、投入与产出比等情况。
3.  **经营管理**：项目是否有清晰的企业发展目标；是否有完备的研发、生产、运营、营销等制度和体系；是否采用先进科学的管理方法，以确保企业具有较强的竞争力。
4.  **成长前景**：项目是否有清晰、有效、全方位的企业发展战略，并拥有可靠的内外部资源（人才、资金、技术等方面）实现企业战略，以建立企业的持续竞争优势。项目是否具备国际化发展的潜力。
5.  **财务管理**：关注项目融资情况、获取资金渠道情况、企业经营的现金流情况、融资需求及资金使用情况是否合理。
6.  **社会影响**：项目直接或间接带动就业的数量和质量，对促进区域经济发展、产业转型升级的情况，对社会文明、生态文明、民生福祉等方面的积极推动作用。

### **团队协作 (15分)**
1.  **团队精神**：团队是否有明确的使命愿景，具有团结协作的创新精神，具有独特的支撑项目成长的知识、技能、经验以及成熟的外部资源网络。
2.  **团队结构**：公司是否具有合理的组织构架、清晰的指挥链、科学的决策机制；是否有合理的岗位设置、分工协作、专业能力结构；是否有良好的内部沟通机制；是否有合理的股权结构、激励制度等；鼓励留学生参与，促进中外合作交流。
3.  **团队效能**：团队对项目的各项投入情况及团队成员的稳定性情况。
4.  **团队资源**：支撑公司发展的合作伙伴等外部资源的使用以及与公司关系的情况。
""".strip(),
    CompetitionGroup.RED_TOUR_PUBLIC_WELFARE: """
### **个人成长 (30分)**
1.  **立德树人**：项目弘扬正确价值观，厚植家国情怀，恪守伦理规范，有助于培育创新精神。
2.  **调研深入**：项目扎根中国大地了解国情民情，鼓励学生深入社会、行业、实验场所选题立项、调查研究、试验论证。
3.  **逻辑正确**：项目遵循发现问题、分析问题、解决问题的基本规律，将所学专业知识、技能和方法应用于解决各类社会问题。
4.  **知识掌握与应用能力**：体现用课堂和实验室学到的知识解决实际问题的综合能力和高级思维；体现项目成长对团队成员创新创业精神、意识、能力的锻炼和提升作用，展现创新教育对大学生基本素养和认知的塑造力和提升大学生综合能力的效力。
5.  **人才培养成效**：项目能充分体现院校扎实推进新工科、新医科、新农科、新文科建设方面取得的成果；项目充分体现专业教育、思政教育、创新教育的有机融合；体现院校在项目的培育、孵化等方面的支持情况。

### **公益价值 (10分)**
1.  **社会价值**：项目以社会价值为导向，以谋求公共利益为目的，以解决社会问题为使命，不以营利为目标，有一定公益成果。
2.  **社会效益**：在公益服务领域具有较好的创意、产品或服务模式的创业计划和实践，追求社会效益的最大化。

### **项目创新 (20分)**
1.  **问题导向**：团队能够基于科学严谨的创新过程，遵循创新规律，运用各类创新的理念和范式，解决社会实际需求。
2.  **创新成效**：项目能够从产品创新、服务创新等方面着手开展公益创业实践，并产生一定数量和质量的创新成果。
3.  **公益成效**：鼓励将高校科研成果运用到公益创业中，以解决相应的社会问题。

### **发展前景 (20分)**
1.  **发展条件**：项目通过吸纳捐赠、获取政府资助、自营收等方式确保持续生存能力情况。
2.  **营销效果**：团队基于一定的产品、服务、模式，通过高效管理、资源整合、活动策划等运营手段，确保项目影响力与实效性。
3.  **社会影响**：项目对带动大学生到农村、城乡社区从事社会服务就业创业的情况，在促进就业、教育、医疗、养老、生态文明、民生福祉等方面的积极推动作用。
4.  **推广成效**：项目的模式可复制、可推广、具有示范效应。

### **团队协作 (20分)**
1.  **团队精神**：团队有明确的使命愿景，具有团结协作的创新精神，具有从事公益创业所需的知识、技术和经验。
2.  **团队结构**：团队内部的组织构架、人员配置、分工协作、能力结构、专业结构、激励制度的合理性情况；团队外部服务支撑体系完备（如志愿者团队等）、具有一定规模、实施有效管理使其发挥重要作用的情况。
3.  **团队效能**：团队与项目关系的真实性、紧密性情况；团队对项目的各项投入情况；团队的延续性或接替性情况。
4.  **团队资源**：支撑项目发展的合作伙伴等外部资源的使用以及与项目关系的情况。

### **必要条件**
* 参加由学校、省市或全国组织的“青年红色筑梦之旅”活动。
""".strip(),
    CompetitionGroup.RED_TOUR_CREATIVITY: """
### **个人成长 (30分)**
1.  **立德树人**：项目弘扬正确价值观，厚植家国情怀，恪守伦理规范，有助于培育创新精神。
2.  **调研深入**：项目扎根中国大地了解国情民情，鼓励学生深入社会、行业、实验场所选题立项、调查研究、试验论证。
3.  **逻辑正确**：项目遵循发现问题、分析问题、解决问题的基本规律，将所学专业知识、技能和方法应用于科技创新、乡村振兴、城市社区治理、城乡融合发展等方面。
4.  **知识掌握与应用能力**：体现团队用课堂和实验室学到的知识解决实际问题的综合能力和高级思维，体现项目成长对团队成员创新创业精神、意识、能力的锻炼和提升作用，展现创新教育对大学生基本素养和认知的塑造力和提升大学生综合能力的效力。
5.  **人才培养成效**：项目能充分体现院校扎实推进新工科、新医科、新农科、新文科建设方面取得的成果；项目充分体现专业教育、思政教育、创新教育的有机融合；体现院校在项目的培育、孵化等方面的支持情况。

### **项目创新 (30分)**
1.  **解决方法**：团队能够基于科学严谨的创新过程，遵循创新规律，运用各类创新的理念和范式，解决科技创新、乡村振兴、城市社区治理、城乡融合发展中遇到的各类问题。
2.  **创新成效**：项目能够从产品创新、服务创新等方面着手开展创新创业实践，并产生一定数量和质量的创新成果。
3.  **创新应用**：鼓励院校科研成果和文创成果在乡村或社区进行产业转化落地与实践应用。
4.  **模式创新**：鼓励组织模式或商业模式创新，鼓励资源整合优化创新。

### **发展前景 (20分)**
1.  **基础调研**：充分了解科技创新、乡村振兴、城市社区治理、城乡融合发展的内容和要求，了解其中的痛点、难点，进而形成对所要解决问题完备的认知。
2.  **发展创意**：在服务科技创新、乡村振兴、城市社区治理、城乡融合发展等方面有较好的创意、产品或服务模式，追求经济效益和社会效益的平衡。
3.  **社会贡献**：项目对推动科技 innovation、乡村振兴、城市社区治理、城乡融合发展的贡献度。项目直接或间接带动就业的数量和质量，对社会文明、生态文明、民生福祉等方面的积极推动作用。
4.  **推广成效**：项目的持续生存能力，模式可复制、可推广、具有示范效应等。

### **团队协作 (20分)**
1.  **团队精神**：团队的组成原则与过程是否科学合理；团队是否具有支撑项目成长的知识、技术和经验；是否有明确的使命愿景。
2.  **团队结构**：团队的组织构架、人员配置、分工协作、能力结构、专业结构、合作机制、激励制度等的合理性情况。
3.  **团队效能**：团队与项目关系的真实性、紧密性情况；对项目的各项投入情况；创立创业企业的可能性情况。
4.  **团队资源**：支撑项目发展的合作伙伴等外部资源的使用以及与项目关系的情况。

### **必要条件**
* 参加由学校、省市或全国组织的“青年红色筑梦之旅”活动。
""".strip(),
    CompetitionGroup.RED_TOUR_ENTREPRENEURSHIP: """
### **个人成长 (25分)**
1.  **立德树人**：项目弘扬正确价值观，厚植家国情怀，恪守伦理规范，有助于培育创新精神。
2.  **调研深入**：项目扎根中国大地了解国情民情，鼓励学生深入社会、行业、实验场所选题立项、调查研究、试验论证。
3.  **逻辑正确**：项目遵循发现问题、分析问题、解决问题的基本规律，将所学专业知识、技能和方法应用于科技创新、乡村振兴、城市社区治理、城乡融合发展等方面。
4.  **知识掌握与应用能力**：项目体现团队用课堂和实验室学到的知识解决实际问题的综合能力和高级思维，体现对团队成员创新创业精神、意识、能力的锻炼和提升作用，展现创新教育对大学生基本素养和认知的塑造力和提升大学生综合能力的效力。
5.  **人才培养成效**：项目能充分体现院校扎实推进新工科、新医科、新农科、新文科建设方面取得的成果；项目充分体现专业教育、思政教育、创新教育的有机融合；体现院校在项目的培育、孵化等方面的支持情况。

### **项目创新 (30分)**
1.  **解决方法**：团队能够基于科学严谨的创新过程，遵循创新规律，运用各类创新的理念和范式，解决科技创新、乡村振兴、城市社区治理、城乡融合发展中遇到的各类问题。
2.  **创新成效**：项目能够从产品创新、服务创新、组织创新等方面着手开展创新创业实践，并产生一定数量和质量的创新成果，获得相应的市场回报。
3.  **创新应用**：鼓励院校科研成果和文创成果在乡村或社区进行产业转化落地与实践应用。

### **发展前景 (25分)**
1.  **基础调研**：充分了解科技创新、乡村振兴、城市社区治理、城乡融合发展的内容和要求，了解其中的痛点、难点，进而形成对所要解决问题完备的认知。
2.  **发展创意**：在服务科技创新、乡村振兴、城市社区治理、城乡融合发展等方面有较好产品或服务模式，追求经济效益和社会效益的平衡。
3.  **社会贡献**：项目通过商业方式推动科技创新、乡村振兴、城市社区治理、城乡融合发展的贡献度。项目直接或间接带动就业的数量和质量，对社会文明、生态文明、民生福祉等方面的积极推动作用。
4.  **推广成效**：项目的持续生存能力，模式可复制、可推广、具有示范效应等。

### **团队协作 (20分)**
1.  **团队精神**：团队的组成原则与过程是否科学合理，团队成员的教育和工作背景、创新能力、价值观念、分工协作和能力互补情况，是否有明确的使命愿景。
2.  **团队结构**：公司是否具有合理的组织构架、清晰的指挥链、科学的决策机制；是否有合理的岗位设置、分工协作、专业能力结构；是否有良好的内部沟通机制；是否有合理的股权结构、激励制度。
3.  **团队效能**：团队对项目的各项投入情况及团队成员的稳定性情况。
4.  **团队资源**：支撑公司发展的合作伙伴等外部资源的使用以及与公司关系的情况。

### **必要条件**
* 参加由学校、省市或全国组织的“青年红色筑梦之旅”活动。
""".strip(),
    CompetitionGroup.INDUSTRY_ENTERPRISE_PROPOSITION: """
### **个人成长 (30分)**
1.  **立德树人**：项目弘扬正确的价值观，厚植家国情怀，恪守伦理规范，有助于培育创新精神。
2.  **调研深入**：项目扎根中国大地了解国情民情，鼓励学生深入社会、行业、实验场所选题立项、调查研究、试验论证。
3.  **逻辑正确**：项目符合将专业知识与产业实际问题有效结合，并转化为商业价值或社会价值，展现创新教育对大学生基本素养和认知的塑造力和提升大学生综合能力的效力。
4.  **知识掌握与应用能力**：项目体现团队用课堂和实验室学到的知识解决实际问题的综合能力和高级思维，体现对团队成员创新精神、创新意识、创新能力的锻炼和提升作用。
5.  **人才培养成效**：项目能充分体现院校扎实推进新工科、新医科、新农科、新文科建设方面取得的成果；体现院校在项目的培育、孵化等方面的支持情况；体现产教融合、科教融汇、多学科交叉、专创融合、产学研协同创新等模式在项目的产生与执行中的重要作用。

### **项目创新 (20分)**
1.  **创新理念**：用于解决命题的创意、技术、方案、模式等的先进性情况。团队基于科学严谨的创新过程，遵循创新规律，运用各类创新的理念和范式解决命题。
2.  **创新成效**：基于企业命题开放创新的内在要求，促进企业（机构）将内外部资源有机整合，提高其创新效率的情况。

### **团队协作 (20分)**
1.  **团队结构**：团队的组成原则与过程是否科学合理，是否具有支撑解决命题的知识、技术和经验。团队的组织构架、人员配置、分工协作、能力互补、专业结构的合理性情况。
2.  **团队效能**：团队与项目关系的真实性、紧密性情况，团队对项目的各项投入情况，团队与企业（机构）持续合作的可能性情况。
3.  **团队资源**：支撑项目发展的合作伙伴等外部资源的使用以及与项目关系的情况。

### **实现成效 (20分)**
1.  **实施方案**：解决命题过程的规划和工作进度安排合理，在各阶段工作目标清晰，难点明确，重点突出，并能兼顾目标与资源配置。
2.  **需求匹配**：解决方案匹配企业（机构）命题要求，解决方案具备先进性、现实性、经济性、高完成度等特点。
3.  **社会效益**：命题解决方案是否解决企业（机构）命题中涉及的问题，以及为企业（机构）带来经济效益、社会效益的潜力情况。

### **项目分析 (10分)**
1.  **需求调研**：全方位开展与所选命题相关的产业（行业）的产业规模、增长速度、竞争格局、产业趋势、产业政策以及市场的定位、特征、需求等方面的调研，形成一手资料。
2.  **资源对接**：系统、深入了解企业（机构）内外部环境情况，通过与企业对接，准确把握其实际需求与痛点，明确解决该命题所需的各类资源。
3.  **解决方案**：结合企业（机构）的产品、技术、模式、管理、制度等现实情况与本团队的创意、技术、方案、人才等。
""".strip(),
    CompetitionGroup.INDUSTRY_ACHIEVEMENT_TRANSFORMATION: """
### **个人成长 (25分)**
1.  **立德树人**：项目弘扬正确的价值观，厚植家国情怀，恪守伦理规范，有助于培育创新精神。
2.  **调研深入**：项目扎根中国大地了解国情民情，鼓励学生深入社会、行业、实验场所选题立项、调查研究、试验论证。
3.  **逻辑正确**：项目符合将专业知识与产业实际问题有效结合，并转化为商业价值或社会价值，展现创新教育对大学生基本素养和认知的塑造力和提升大学生综合能力的效力。
4.  **知识掌握与应用能力**：项目体现团队用课堂和实验室学到的知识解决实际问题的综合能力和高级思维，体现对团队成员创新精神、创新意识、创新能力的锻炼和提升作用。
5.  **人才培养成效**：项目能充分体现院校扎实推进新工科、新医科、新农科、新文科建设方面取得的成果；体现院校在项目的培育、孵化等方面的支持情况；体现产教融合、科教融汇、多学科交叉、专创融合、产学研协同创新等模式在项目的产生与执行中的重要作用。

### **项目创新 (30分)**
1.  **问题导向**：项目遵循从创意到研发、试制、生产、进入市场的创新一般过程，进而实现从创意向实践、从基础研发向应用研发的跨越。
2.  **目标导向**：团队能够基于专业知识并运用各类创新的理念和范式，解决社会和市场的实际需求。
3.  **创新成效**：项目能够从产品创新、工艺流程创新、服务创新、商业模式创新等方面着手开展创新实践，产生一定数量和质量的创新成果，获得相应的市场回报。
4.  **发展前景**：项目能够从创新战略、创新流程、创新组织、创新制度与文化等方面进行设计协同，对创新进行有效管理，进而保持公司的竞争力。

### **产业价值 (30分)**
1.  **产业发展**：充分掌握所在产业（行业）的产业规模、增长速度、竞争格局、产业趋势、产业政策等情况；具有明确的目标市场定位，充分掌握目标市场的特征、需求等情况；具有完整、创新、可行的商业模式。
2.  **经营绩效**：重点考察项目存续时间、营业收入（合同订单）现状、企业利润、持续盈利能力、市场份额、客户（用户）情况、税收上缴、投入与产出比等情况。
3.  **经营管理**：项目是否有清晰的企业发展目标；是否有完备的研发、生产、运营、营销等制度和体系；是否采用先进、科学的管理方法，以确保企业具有较强的竞争力。
4.  **成长前景**：项目是否有清晰、有效、全方位的企业发展战略，并拥有可靠的内外部资源（人才、资金、技术等方面）实现企业战略，以建立企业的持续竞争优势。项目是否具备国际化发展的潜力。
5.  **财务管理**：关注项目融资情况、获取资金渠道情况、企业经营的现金流情况、融资需求及资金使用情况是否合理。
6.  **社会影响**：项目直接或间接带动就业的数量和质量，对促进区域经济发展、产业转型升级的情况，对社会文明、生态文明、民生福祉等方面的积极推动作用。

### **团队协作 (15分)**
1.  **团队精神**：团队有明确的使命愿景，具有团结协作的创新精神，具有独特的支撑项目成长的知识、技能、经验以及成熟的外部资源网络。
2.  **团队结构**：公司是否具有合理的组织构架、清晰的指挥链、科学的决策机制；是否有合理的岗位设置、分工协作、专业能力结构；是否有良好的内部沟通机制；是否有合理的股权结构、激励制度等；鼓励留学生参与，促进中外合作交流。
3.  **团队效能**：团队对项目的各项投入情况及团队成员的稳定性情况。
4.  **团队资源**：支撑公司发展的合作伙伴等外部资源的使用以及与公司关系的情况。
""".strip(),
}


class BPReviewerAgent:
    def __init__(self, model_name: str = None):
        if model_name is None:
            model_name = get_model_name()

        model = self._create_model(model_name)

        self.agent = Agent(
            model,
            output_type=str,
            retries=2,
        )

    def _create_model(self, model_name: str):
        """创建自定义LLM模型实例"""
        provider = create_llm_provider()
        if provider:
            from pydantic_ai.models.openai import OpenAIChatModel

            return OpenAIChatModel(model_name, provider=provider)
        return model_name

    def _get_prompt(self, context: BPReviewContext) -> str:
        rules = group_rules_map.get(
            context.group, "未找到适用的评审规则，请使用通用商业评估标准。"
        )
        return f"""
# 互联网+大赛专业评审
## 角色设定
你是一位经验丰富、标准严苛的互联网+大赛评委，以挑剔的眼光审视每个项目，善于发现问题和不足，倾向于给出较为保守的分数以促进项目改进。你的评审风格以严格著称，更关注项目的实际可行性和深层次问题。

## 任务简述
根据给定的评分细则，对互联网+大赛项目商业计划书（BP）进行严格评分，重点挖掘项目不足并以详细表格形式输出结果。

## 商业计划书内容
```
{context.bp_content}
```

## 执行步骤

### 1. 验证材料完整性
- **检测** BP内容是否成功读取。
- **判断** 若未读到内容，立即返回错误提示："未读到商业计划书内容，请确认内容已正确提供。"
- **继续** 若内容读取成功，进入后续严格评审流程。

### 2. 解析评分细则结构
- **识别** 评分细则中的一级指标（### **评审一级指标X (该项总分)**）。
- **提取** 每个一级指标下的总分数值。
- **解析** 各一级指标下的二级内容列表（1. **评审二级内容X**：说明）。
- **建立** 严格的评分标准映射关系。

### 3. 深度审阅BP内容
- **逐项细读** BP全部内容，以挑剔眼光审视每个细节。
- **质疑** 项目的可行性、逻辑性和完整性。
- **识别** 数据不足、论证薄弱、表述模糊等问题。
- **记录** 每个潜在缺陷和改进空间。

### 4. 执行分层次严格评分
- **遍历** 每个一级指标下的所有二级内容。
- **识别问题** 针对该评分点发现具体问题和不足。
- **深度分析** 挖掘问题背后的深层次原因和影响。
- **确定扣分** 基于问题严重程度给出具体扣分理由。
- **提出建议** 针对发现的问题给出具体可行的改进措施。
- **保守给分** 综合问题严重程度确定最终得分。

### 5. 构建详细评分表格
- **创建** 七列表格，按照问题识别、深度分析、扣分理由、改进建议的逻辑顺序填写。
- **确保** 每个评分点的四个分析维度内容充实且逻辑连贯。
- **保持** 严格性与一致性的评分标准。
- **汇总** 总分并给出整体评价。

## 评审规则
{rules}
## 输出格式说明

### 表格结构（Markdown格式）
```markdown
| 评审一级指标 | 评审二级内容 | 得分/满分 | 问题识别 | 深度分析 | 扣分理由 | 改进建议 |
|-------------|-------------|-----------|----------|----------|----------|----------|
| [一级指标] | [二级内容] | X/Y | [具体问题] | [深层分析] | [扣分依据] | [改进措施] |
| **总计** | **所有评分项** | **X/Y** | **主要问题汇总** | **整体问题分析** | **总体扣分说明** | **核心改进方向** |
```

### 各列内容要求

#### 问题识别（50-100字）
- **聚焦** 该评分点下发现的具体问题。
- **明确** 问题的具体表现。
- **客观** 描述问题现象，避免主观判断。

#### 深度分析（100-150字）
- **挖掘** 问题产生的根本原因。
- **评估** 问题对项目整体的影响程度。
- **关联** 该问题与其他方面的相互关系。

#### 扣分理由（50-80字）
- **量化** 问题导致的具体扣分点数。
- **说明** 扣分的客观依据和标准。
- **对比** 与优秀项目标准的差距。

#### 改进建议（80-120字）
- **针对性** 提出解决具体问题的措施。
- **可操作** 确保建议具体可执行。
- **优先级** 标明改进的紧迫程度。

### 评分原则
- **严格标准**：采用偏严格的评分尺度，发现问题比肯定优点更重要。
- **保守给分**：在合理范围内倾向于给出较低分数，为项目留出改进空间。
- **问题导向**：每个评分点都要识别出具体问题。
- **逻辑闭环**：问题识别→深度分析→扣分理由→改进建议形成完整逻辑链。

### 严格评审要点
- **质疑数据**：对所有数据和假设保持怀疑态度。
- **挑战逻辑**：深入检视商业逻辑和技术路线的合理性。
- **关注风险**：重点识别项目可能面临的各种风险。
- **检视细节**：不放过任何表述不清或论证不足的地方。
- **标准从严**：在评分时采用更为严格的评价标准。

### 防错提示
- **注意**：若BP某部分内容缺失，在问题识别中明确说明"信息缺失"，在深度分析中说明影响，在扣分理由中体现相应扣分。
- **要求**：每个二级内容都必须填写完整的四个分析维度。
- **提醒**：表格格式必须严格按照Markdown标准，确保七列内容显示正确。
- **强调**：即使项目表现较好的方面，也要找出潜在问题和改进空间。
""".strip()

    async def review(self, group: CompetitionGroup, bp_content: str) -> str:
        if not bp_content or not bp_content.strip():
            return "未读到商业计划书内容，请确认内容已正确提供。"

        context = BPReviewContext(group=group, bp_content=bp_content)
        prompt = self._get_prompt(context)
        result = await self.agent.run(prompt)
        return result.output


def create_bp_reviewer_agent(model_name: str = None) -> BPReviewerAgent:
    """创建BP评审代理实例"""
    return BPReviewerAgent(model_name)
